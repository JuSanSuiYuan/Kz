# 贡献指南

感谢您对Kz编程语言项目的关注与支持！我们欢迎各种形式的贡献，包括代码提交、问题报告、文档改进等。

## 项目结构

```
Kz/
├── compiler/      # 编译器相关代码
├── tools/         # 开发工具（格式化等）
├── examples/      # 示例代码
├── docs/          # 文档
├── tests/         # 测试代码
├── LICENSE        # 许可证文件
├── README.md      # 项目说明
├── CONTRIBUTING.md # 贡献指南
└── kzconfig.toml  # 配置文件
```

## 开发环境设置

### 前提条件

- 支持三进制计算的开发环境
- LLVM 15.0+（用于代码生成）
- CMake 3.20+
- Python 3.9+（用于开发工具）

### 克隆仓库

```bash
git clone https://github.com/kz-lang/kz.git
cd kz

# 查看项目结构
ls -la
```

### 构建工具链

```bash
# 配置构建
cmake -B build -DCMAKE_BUILD_TYPE=Debug

# 编译
cmake --build build -j8

# 安装（可选）
cmake --install build
```

## 贡献流程

### 1. 创建Issue

在开始工作前，建议先创建一个Issue来描述您计划解决的问题或添加的功能。这样可以避免重复工作，并获得社区的反馈。

### 2. 创建分支

从`main`分支创建一个新的功能分支：

```bash
git checkout main
git pull
git checkout -b feature/your-feature-name
```

### 3. 开发

在开发过程中，请遵循以下准则：

- 代码风格保持一致（参考项目中的现有代码）
- 添加适当的注释和文档
- 为新功能编写测试
- 确保不会破坏现有功能

### 4. 提交代码

提交时请使用清晰的提交信息：

```bash
git commit -m "feat: 添加三进制矩阵优化功能"
git commit -m "fix: 修复三进制浮点数精度问题"
git commit -m "docs: 更新README中的示例代码"
```

### 5. 推送分支

```bash
git push origin feature/your-feature-name
```

### 6. 创建Pull Request

在GitHub上创建一个Pull Request，描述您的更改内容和解决的问题。

## 编码规范

### 命名约定

- 函数名：使用小驼峰命名法 `fn calculateSum()` 或中文命名 `fn 计算总和()`
- 变量名：使用小驼峰命名法 `let resultValue` 或中文命名 `let 结果值`
- 常量名：使用全大写加下划线 `const MAX_SIZE`
- 类名：使用大驼峰命名法 `class MemoryManager`
- 文件名：使用小写下划线 `trinary_math.kz`
- **Actor命名**: Actor类型使用大驼峰，后面加Actor后缀，例如 `CalculatorActor`

### 代码格式

- **Python风格缩进**：使用4个空格进行缩进，**不使用大括号**定义代码块
- 每行不超过100个字符
- 行尾序列统一使用**LF（Line Feed）**，避免使用CRLF或CR
- 运算符两侧添加空格：`a + b` 而非 `a+b`
- 结构体初始化使用圆括号：`Trinary(value: 1)`
- 控制流语句后使用冒号和缩进
- **中文关键字**：支持使用`设`代替`var`，`令`代替`let`，推荐在中文项目中使用中文关键字

### 编码支持规范

- **UTF-8优先**：所有源文件默认使用UTF-8编码
- **多编码兼容**：支持ASCII、GB2312、GBK、GB18030、UTF8bom、ANSI、Latin1等编码
- **中英文混合编程**：允许在函数名、变量名、注释中使用中文
- **命名一致性**：同一模块内保持命名风格一致

### 注释规范

- 使用`#`进行行注释（替代`//`）
- 函数和类型上方添加文档字符串
- 复杂算法添加详细注释

## 三进制特有规范

### 三进制数据表示

- 使用平衡三进制（-1、0、1）作为默认表示
- 使用`T`表示-1，`0`表示0，`1`表示1
- 在处理三进制数据时，优先考虑对称性优化

### 性能优化指南

- 利用三进制的信息密度优势，减少内存访问
- 优化三进制特有的运算模式
- 考虑三进制CPU的指令集特性

## 内存管理

- **显式释放**: 所有分配的内存必须显式释放
- **错误处理**: 内存分配失败时必须进行适当的错误处理
- **资源管理**: 使用`defer`语句确保资源正确释放
- **避免内存泄漏**: 注意循环引用和长生命周期对象的内存管理
- **内存池使用**: 优先使用内存池分配频繁使用的小内存块
- **显存管理**: GPU相关内存必须通过显存池进行管理
- **池化策略**: 大对象使用单独分配，小对象使用内存池

## 模式匹配规范

- 使用Python风格的match和match-case语法进行模式匹配
- 保持模式匹配代码的简洁性和可读性
- 优先使用模式匹配而非复杂的if-else链

## MLIR优化规范

- 在性能关键代码中利用MLIR优化通道
- 避免过度优化简单操作
- 测试MLIR优化前后的性能差异

## 链接器规范

1. **使用Mold链接器**：在构建优化版本时默认使用Mold链接器，它比传统链接器快10倍以上。
2. **配置标志**：在`kzconfig.toml`中合理配置链接器标志，平衡性能与调试需求。
3. **多模块项目**：对于大型项目，使用增量链接策略，减少构建时间。
4. **链接脚本**：针对特殊硬件平台，提供自定义链接脚本支持。

## 忆阻器编程规范

1. **设备抽象**：始终通过`MemristorDevice`接口操作忆阻器，避免直接硬件访问。
2. **安全操作**：严格遵守电压和时间安全限制，使用内置的`clamp`函数防止过压。
3. **批量操作优先**：使用`batch_operation`代替多次单操作，提高性能并减少总线开销。
4. **错误处理**：所有忆阻器操作必须包含完善的错误处理和异常捕获。
5. **资源管理**：使用RAII模式管理设备资源，确保设备正确关闭和释放。
6. **模拟器优先开发**：在实际硬件上测试前，先使用`MemristorSimulator`进行开发和测试。
7. **性能监控**：对忆阻器操作进行性能监控，避免频繁操作同一单元。
8. **应用设计**：充分利用忆阻器的非易失性和记忆特性，设计适合的应用场景。

## Actor模型规范

- **隔离性**: Actor之间通过消息传递通信，避免共享状态
- **消息格式**: 消息使用不可变数据结构
- **错误处理**: Actor内部错误不应影响其他Actor
- **监督树**: 实现监督机制处理Actor失败情况
- **命名示例**: `fn 创建计算器Actor() -> ActorRef<CalculatorMessage>:`

## C3模块化规范

- **模块依赖**: 遵循C3线性化规则处理多重继承
- **接口设计**: 优先使用接口而非具体实现
- **组合优先**: 优先使用组合而非继承
- **命名空间**: 使用清晰的命名空间组织代码
- **导入导出**: 明确声明模块导入和导出

## 内联汇编规范

- **注释说明**: 所有内联汇编必须有详细注释
- **可移植性**: 尽量保持汇编代码的可移植性
- **性能测量**: 使用内联汇编前必须进行性能测量对比
- **安全检查**: 确保汇编代码不会破坏内存安全
- **格式要求**: 汇编代码使用缩进和适当的格式

## 池化内存/显存规范

- **池大小配置**: 根据实际需求调整内存池和显存池大小
- **对象生命周期**: 明确池化对象的生命周期管理
- **内存对齐**: 确保池化内存符合硬件对齐要求
- **统计监控**: 实现内存池使用情况的统计和监控
- **动态扩缩容**: 支持内存池的动态扩缩容机制

## 测试

### 运行测试

```bash
# 运行单元测试
ctest -C Debug --test-dir build

# 运行特定测试
ctest -C Debug --test-dir build -R trinary_math
```

### 添加测试

请为新功能添加相应的测试。测试文件应放在`tests`目录下，遵循`*_test.kz`命名格式。

## 报告问题

### Bug报告

当报告Bug时，请提供以下信息：

- Kz语言版本
- 操作系统和硬件信息（特别是三进制硬件相关信息）
- 完整的错误信息
- 复现步骤
- 期望行为与实际行为的对比

### 功能请求

对于功能请求，请描述：

- 您希望添加的功能
- 该功能的使用场景
- 可能的实现方式（如果有）

## 行为准则

参与本项目的所有贡献者都应遵循友好、尊重的交流方式。我们致力于创建一个包容、多样化的社区环境。

## 许可证

本项目采用**木兰2.0许可证**（MulanPSL-2.0）。通过贡献代码，您同意您的贡献将在该许可证下发布。

## 联系方式

- 项目邮箱：contact@kz-lang.org
- 社区论坛：https://forum.kz-lang.org
- Discord频道：https://discord.gg/kz-lang

再次感谢您的贡献！